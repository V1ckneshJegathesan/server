CREATE DATABASE xpd;
USE xpd;

--disable_warnings
DROP TABLE IF EXISTS cx1;
--enable_warnings
CREATE TABLE cx1(i BIGINT, i2 BIGINT, t TEXT)ENGINE=xpand;

INSERT INTO cx1 VALUES (41, 43, 'some1'), (42, 42, 'some2'), (43, 41, 'some3');

SELECT * FROM cx1 ORDER BY i;
SET xpand_select_handler=OFF;

SELECT * FROM cx1 WHERE i>41 AND i2>41;
EXPLAIN SELECT * FROM cx1 WHERE i>41 AND i2>41;
SELECT * FROM cx1 WHERE i>41 AND i2>41 AND t='some2';
EXPLAIN SELECT * FROM cx1 WHERE i>41 AND i2>41 AND t='some2';
SELECT * FROM cx1 WHERE i>i2+1;
EXPLAIN SELECT * FROM cx1 WHERE i>i2+1;

# The plugin doesn't use pushdown conditions for DH as of 10.5.1
# but it is worth to test memory leaks.
SET @@optimizer_switch='derived_merge=OFF';
SELECT * FROM (SELECT * FROM cx1 WHERE i>i2+1) a1 ORDER BY i;
EXPLAIN SELECT * FROM (SELECT * FROM cx1 WHERE i>i2+1) a1 ORDER BY i;
SET xpand_derived_handler=OFF;
SELECT * FROM (SELECT * FROM cx1 WHERE i>i2+1) a1 ORDER BY i;
EXPLAIN SELECT * FROM (SELECT * FROM cx1 WHERE i>i2+1) a1 ORDER BY i;

# SELECT * FROM (SELECT i FROM cx1 WHERE i=42)a1,(SELECT i FROM cx1 WHERE i =42)a2 WHERE a1.i=a2.i;
# EXPLAIN SELECT * FROM (SELECT i FROM cx1 WHERE i=42)a1,(SELECT i FROM cx1 WHERE i =42)a2 WHERE a1.i=a2.i;

USE test;
DROP DATABASE xpd;
